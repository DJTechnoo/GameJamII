<!DOCTYPE html>
<html>
<canvas id="canvas" width="1024" height="512"></canvas>
<script>
/*
FINAL Idea = Zombie evolves, and people get stronger, topdown
*/

	var ctx = canvas.getContext("2d");
	
const CANVAS = document.getElementById("canvas");
const C = CANVAS.getContext("2d");
const W = CANVAS.width; // window WIDTH
const H = CANVAS.height; // window HEIGHT

// Controller stuff-------------------------------
document.addEventListener("keydown", keyboard);
document.addEventListener("keyup", keyboard);

var key = {
    w:false,
    a:false,
    s:false,
    d:false
};

function keyboard(evt){
    state = (evt.type == "keydown")? true:false;
    switch(evt.key){
        case 'w': key.w = state; break;
        case 'a': key.a = state; break;
        case 's': key.s = state; break;
        case 'd': key.d = state; break;
    }
}
//-------------------------------- End controller stuff 

// Helper functions------------------------------

function drawRect(x, y, w, h, col){ // Draw Rectangle
    C.fillStyle = col;
    C.fillRect(x, y, w, h);
}

function drawRectRotation(x, y, w, h, col, r){
    C.save();
    C.translate(x, y);
    C.rotate(r);
    drawRect(-w/2, -h/2, w, h, col);
    C.restore();
}

function clear(col){
    drawRect(0, 0, W, H, col);
}

function walkInDirection(x, y, spd, dir){
    x += Math.cos(dir)*spd;
    y += Math.sin(dir)*spd;
    return [x, y];
}

function cameraFollow(target){
    C.translate(W/2-target.x, H/2-target.y);
}

	
	function drawScore() {
    ctx.font = "16px Arial";
    ctx.fillStyle = "#0095DD";
    ctx.fillText("Score: "+score, 150, 30);
}
	
	

function dist(o1, o2){      // Vector operation, returns distance between two objects
    var dx = o1.x - o2.x;
    var dy = o1.y - o2.y;

    var len = Math.sqrt(dx*dx + dy*dy);
    return len;
}

// ------------------------------------End helper functions 


// Game classes -------------------------------
Civilian = function(x, y, s, col){
    this.x = x;
    this.y = y;
    this.s = s;
    this.col = col;
    this.direction = 0;
    this.turnSpd = 0.05;
    this.walkSpd = 0.2;
    this.turnTimer = 0;
    this.turnThreshhold = Math.random()*200;
    this.leftOrRight = 1;
    this.deathRadius = this.s*0.6;

    this.update = function(){
        if(this.turnTimer < 200){
            this.turnTimer += 1;
            if(this.turnTimer < this.turnThreshhold)
                this.direction += this.turnSpd*this.leftOrRight;
        }
        else {
            this.turnTimer = 0;
            this.turnThreshhold = Math.random()*50;
            this.leftOrRight = Math.floor(Math.random()*2-1);
        }

        var newDirection = walkInDirection(this.x, this.y, this.walkSpd, this.direction);
        this.x = newDirection[0];
        this.y = newDirection[1];

        var distanceToPlayer = dist(player, this);
        if(distanceToPlayer < this.deathRadius) { 
		this.col = "red";
		player.ate();									   
		};       

    }

    this.draw = function(){
        drawRectRotation(this.x, this.y, this.s, this.s, this.col, this.direction);
    }
}


Player = function(x, y, s, col){
    this.x = x;
    this.y = y;
    this.s = s;
    this.direction = 0;
    this.turnSpd = 0.05;
    this.walkSpd = 0.5;
    this.col = col;
    this.life = 100;
    this.maxLife = 100;

    this.draw = function(){
        drawRectRotation(this.x, this.y, this.s, this.s, this.col, this.direction);
    }

    this.update = function(){
        if(key.a) this.direction -= this.turnSpd;
        if(key.d) this.direction += this.turnSpd;

        var newDirection = [this.x, this.y];
        if(key.w) newDirection = walkInDirection(this.x, this.y, this.walkSpd, this.direction);
        this.x = newDirection[0];
        this.y = newDirection[1];
        if(this.life > 0) this.life -= 0.1;
        else this.life = 0;   
    }
	this.ate = function(){
		if (this.life <= this.maxLife) this.life +=1;
	}
}

Healthbar = function(len, col) {
	this.col = col;
	this.len = len
	
	this.draw = function()  {
		drawRect(15, 15, player.maxLife + 10, 30, "cyan");
		drawRect(20,20, player.life, 20, this.col)
	}
	this.death = function () {
		if (player.life == 0){ alert("game over");	}	
}}

Sound = function sound(src) {
  this.sound = document.createElement("audio");
  this.sound.src = src;
  this.sound.setAttribute("preload", "auto");
  this.sound.setAttribute("controls", "none");
  this.sound.style.display = "none";
  document.body.appendChild(this.sound);
  this.play = function(){
    this.sound.play();
  }
  this.stop = function(){
    this.sound.pause();
  }
} 


// -----------------------------End game classes 

// Game setup   ----------------------------

var player = new Player(200, 200, 20, "cyan");
var civilians = [
    new Civilian(Math.random()*(W-200)+100, Math.random()* (H-200)+100, 20, "pink"),
    new Civilian(Math.random()*(W-200)+100, Math.random()* (H-200)+100, 20, "pink"),
    new Civilian(Math.random()*(W-200)+100, Math.random()* (H-200)+100, 20, "pink"),
    new Civilian(Math.random()*(W-200)+100, Math.random()* (H-200)+100, 20, "pink"),
    new Civilian(Math.random()*(W-200)+100, Math.random()* (H-200)+100, 20, "pink")
];
var health = new Healthbar(100, "green");
var score = 0;
	// var sound = new Sound("hitSound.mp3");	// mySound.play(); to play when player hits/eats object
var music = new Sound("assets/wargod.mp3");
music.play();
	

	
//---------------------------- End game setup

// RECURSIVE MAIN GAMELOOP
function gameLoop(){
    clear("rgba(0, 0, 0, 1.0)");

    // ALL UPDATE FUNCTION MUST COME BELOW THIS---------------
    player.update();
	for(var i in civilians)
        civilians[i].update();
	
	
	
	score++;
	
    // ---------------------------------------------END updates
	drawScore();				// Draws score top left corner
    C.save();                   // Needed for camera
    cameraFollow(player);       // Camera targets player
	
    // ALL DRAW FUNCTION MUST COME BELOW THIS------------------
	
    // demonstrate the draw functions
    player.draw();
    for(var i in civilians)	
        civilians[i].draw();
    drawRect(500, 200, 400, 20, "green");
    drawRectRotation(200, 500, 300, 10, "blue", 9);
	
    
    //------------------ --------------------------END Drawings
    C.restore();        // Needed for camera
    //  HUD STUFF----------------------------------------------

	health.draw();
	health.death();
    // ----------------------------------- End HUD
    requestAnimationFrame(gameLoop);
}



requestAnimationFrame(gameLoop);


</script>
</html>